<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Python进行数据处理 | covid-19-app 文档</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/docs/assets/css/0.styles.52bb2005.css" as="style"><link rel="preload" href="/docs/assets/js/app.b0a15833.js" as="script"><link rel="preload" href="/docs/assets/js/2.18927d2b.js" as="script"><link rel="preload" href="/docs/assets/js/10.5c238dfe.js" as="script"><link rel="prefetch" href="/docs/assets/js/11.2da91d8e.js"><link rel="prefetch" href="/docs/assets/js/12.16979dbe.js"><link rel="prefetch" href="/docs/assets/js/13.7f94e9c0.js"><link rel="prefetch" href="/docs/assets/js/14.5123bec2.js"><link rel="prefetch" href="/docs/assets/js/15.16ae75a4.js"><link rel="prefetch" href="/docs/assets/js/16.5a145cd8.js"><link rel="prefetch" href="/docs/assets/js/17.d9f7e318.js"><link rel="prefetch" href="/docs/assets/js/18.ae462d82.js"><link rel="prefetch" href="/docs/assets/js/3.9c229156.js"><link rel="prefetch" href="/docs/assets/js/4.e05c873c.js"><link rel="prefetch" href="/docs/assets/js/5.f3e6ed41.js"><link rel="prefetch" href="/docs/assets/js/6.498ab014.js"><link rel="prefetch" href="/docs/assets/js/7.3f5168c2.js"><link rel="prefetch" href="/docs/assets/js/8.4cd0f27c.js"><link rel="prefetch" href="/docs/assets/js/9.c23fac6c.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.52bb2005.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">covid-19-app 文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/docs/python/" class="nav-link router-link-active">
  Python
</a></div><div class="nav-item"><a href="/docs/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/docs/ts/" class="nav-link">
  TypeScript
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目地址啊" class="dropdown-title"><span class="title">项目地址</span> <span class="arrow down"></span></button> <button type="button" aria-label="项目地址啊" class="mobile-dropdown-title"><span class="title">项目地址</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/IRVINGwu/flask-vue-project" target="_blank" rel="noopener noreferrer" class="nav-link external">
  flask+Vue2.x项目
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/IRVINGwu/flask-vue-projectV3" target="_blank" rel="noopener noreferrer" class="nav-link external">
  flask+Vue3.0项目
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/IRVINGwu/flask-vue-projectV2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  flask+Vue3.0+TypeScript项目
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/docs/python/" class="nav-link router-link-active">
  Python
</a></div><div class="nav-item"><a href="/docs/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/docs/ts/" class="nav-link">
  TypeScript
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目地址啊" class="dropdown-title"><span class="title">项目地址</span> <span class="arrow down"></span></button> <button type="button" aria-label="项目地址啊" class="mobile-dropdown-title"><span class="title">项目地址</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/IRVINGwu/flask-vue-project" target="_blank" rel="noopener noreferrer" class="nav-link external">
  flask+Vue2.x项目
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/IRVINGwu/flask-vue-projectV3" target="_blank" rel="noopener noreferrer" class="nav-link external">
  flask+Vue3.0项目
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/IRVINGwu/flask-vue-projectV2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  flask+Vue3.0+TypeScript项目
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/docs/" aria-current="page" class="sidebar-link">Home</a></li><li><a href="/docs/python/python01.html" class="sidebar-link">Flask构建后端接口</a></li><li><a href="/docs/python/python02.html" aria-current="page" class="active sidebar-link">Python进行数据处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/python/python02.html#处理疫情数据" class="sidebar-link">处理疫情数据</a></li><li class="sidebar-sub-header"><a href="/docs/python/python02.html#爬取新闻内容" class="sidebar-link">爬取新闻内容</a></li><li class="sidebar-sub-header"><a href="/docs/python/python02.html#根据疫情数据预测下一周疫情情况" class="sidebar-link">根据疫情数据预测下一周疫情情况</a></li><li class="sidebar-sub-header"><a href="/docs/python/python02.html#编写数据请求接口" class="sidebar-link">编写数据请求接口</a></li><li class="sidebar-sub-header"><a href="/docs/python/python02.html#使用gevent将flask改造成异步服务器" class="sidebar-link">使用Gevent将flask改造成异步服务器</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="python进行数据处理"><a href="#python进行数据处理" class="header-anchor">#</a> Python进行数据处理</h1> <h2 id="处理疫情数据"><a href="#处理疫情数据" class="header-anchor">#</a> 处理疫情数据</h2> <p>我的疫情数据由<code>https://github.com/CSSEGISandData/COVID-19</code>这里得到，由于是excel表格的形式，所以使用<code>pandas</code>库来处理是最好的。里面的数据格式比较奇怪，因为一般我们的数据都是日期列在第一列，方便我们进行制图，但是这里的数据日期是第一行，所以我们需要将行列进行互换。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd

<span class="token keyword">def</span> <span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 数据地址</span>
    urls <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">'time_series_covid19_confirmed_global.csv'</span><span class="token punctuation">,</span>
        <span class="token string">'time_series_covid19_deaths_global.csv'</span><span class="token punctuation">,</span>
        <span class="token string">'time_series_covid19_recovered_global.csv'</span><span class="token punctuation">]</span>
    <span class="token comment"># 因为pandas不能同时处理to_csv这种方法，所以要分开</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> urls<span class="token punctuation">:</span>
        <span class="token comment"># 保存为文件的地址，文件名取的是confirmed_china这种形式</span>
        name <span class="token operator">=</span> <span class="token string">'../static/data/'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'_china.csv'</span>
        <span class="token comment"># 读取文件的地址</span>
        path <span class="token operator">=</span> <span class="token string">'../static/data/'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>path<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

        <span class="token comment"># 获取中国的数据</span>
        df_china <span class="token operator">=</span> df<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'Country/Region'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'China'</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
        df_china<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Country/Region'</span><span class="token punctuation">,</span> <span class="token string">'Lat'</span><span class="token punctuation">,</span> <span class="token string">'Long'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                      axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token comment"># 将省份作为行标，便于后面的行列转置</span>
        df_china<span class="token punctuation">.</span>set_index<span class="token punctuation">(</span><span class="token string">'Province/State'</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token comment"># 进行行列转置</span>
        df_china <span class="token operator">=</span> df_china<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 保存为单独的文件</span>
        df_china<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>name<span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 合并清洗好的中国、世界疫情数据文件，并保存为一个单独的文件</span>
<span class="token keyword">def</span> <span class="token function">combineNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'confirmed_china'</span><span class="token punctuation">,</span> <span class="token string">'deaths_china'</span><span class="token punctuation">,</span> <span class="token string">'recovered_china'</span><span class="token punctuation">]</span>
    ls_world <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'confirmed_world'</span><span class="token punctuation">,</span> <span class="token string">'deaths_world'</span><span class="token punctuation">,</span> <span class="token string">'recovered_world'</span><span class="token punctuation">]</span>
    titles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'确诊病例'</span><span class="token punctuation">,</span> <span class="token string">'死亡病例'</span><span class="token punctuation">,</span> <span class="token string">'康复病例'</span><span class="token punctuation">]</span>
    df_empty <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'省份'</span><span class="token punctuation">,</span> <span class="token string">'日期'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    df_empty_world <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'国家'</span><span class="token punctuation">,</span> <span class="token string">'日期'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 读取文件</span>
            path <span class="token operator">=</span> <span class="token string">'../static/data/'</span> <span class="token operator">+</span> ls<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.csv'</span>
            df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>
                path<span class="token punctuation">,</span>
                encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span>
                names<span class="token operator">=</span><span class="token punctuation">[</span>
                    <span class="token string">'省份'</span><span class="token punctuation">,</span>
                    <span class="token string">'日期'</span><span class="token punctuation">,</span>
                    titles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

            <span class="token comment"># 删除首行不需要的标题</span>
            df <span class="token operator">=</span> df<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

            <span class="token comment"># 合并文件</span>
            df_empty <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>
                left<span class="token operator">=</span>df_empty<span class="token punctuation">,</span> right<span class="token operator">=</span>df<span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token punctuation">[</span>
                    <span class="token string">'省份'</span><span class="token punctuation">,</span> <span class="token string">'日期'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'outer'</span><span class="token punctuation">)</span>
        <span class="token comment"># 保存为文件</span>
        df_empty<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>
            <span class="token string">'../static/data/china_all.csv'</span><span class="token punctuation">,</span>
            index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
            sep<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">,</span>
            encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 读取文件</span>
            path_world <span class="token operator">=</span> <span class="token string">'../static/data/'</span> <span class="token operator">+</span> ls_world<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.csv'</span>
            df_world <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>
                path_world<span class="token punctuation">,</span>
                encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span>
                names<span class="token operator">=</span><span class="token punctuation">[</span>
                    <span class="token string">'国家'</span><span class="token punctuation">,</span>
                    <span class="token string">'日期'</span><span class="token punctuation">,</span>
                    titles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

            <span class="token comment"># 删除首行不需要的标题</span>
            df_world <span class="token operator">=</span> df_world<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

            <span class="token comment"># 合并文件</span>
            df_empty_world <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>
                left<span class="token operator">=</span>df_empty_world<span class="token punctuation">,</span> right<span class="token operator">=</span>df_world<span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token punctuation">[</span>
                    <span class="token string">'国家'</span><span class="token punctuation">,</span> <span class="token string">'日期'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'outer'</span><span class="token punctuation">)</span>

        <span class="token comment"># 保存为文件</span>
        df_empty_world<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>
            <span class="token string">'../static/data/world_all.csv'</span><span class="token punctuation">,</span>
            index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
            sep<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">,</span>
            encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> BaseException<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'不成功'</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="爬取新闻内容"><a href="#爬取新闻内容" class="header-anchor">#</a> 爬取新闻内容</h2> <p>现在的网页大部分都加上了滚动加载的功能，而使用<code>request</code>库只能爬取到已经加载的DOM内容，明显是不行的，所以需要<code>selenium</code>库来模拟浏览的过程，让页面自动向下滚动，达到目标高度之后不再滚动，这样我们爬取到的内容就比较丰富了。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>chrome<span class="token punctuation">.</span>options <span class="token keyword">import</span> Options
<span class="token keyword">import</span> time

<span class="token comment"># 使用selenium模拟页面滚动，获取内容</span>
<span class="token keyword">def</span> <span class="token function">get_content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建chrome浏览器驱动</span>
    chrome_options <span class="token operator">=</span> Options<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 让浏览器界面打开时为最大</span>
    chrome_options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">&quot;--start-maximized&quot;</span><span class="token punctuation">)</span>
    driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>
        <span class="token string">&quot;../static/tools/chromedriver.exe&quot;</span><span class="token punctuation">,</span>
        options<span class="token operator">=</span>chrome_options<span class="token punctuation">)</span>

    <span class="token comment"># 加载界面</span>
    driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span>
        <span class="token string">&quot;https://www.sohu.com/c/8/1461?spm=smpc.news-home.top-subnav.3.1608633802228Wu4UITH&quot;</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

    <span class="token comment"># 获取页面初始高度</span>
    js <span class="token operator">=</span> <span class="token string">&quot;return action=document.body.scrollHeight&quot;</span>
    height <span class="token operator">=</span> driver<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span>js<span class="token punctuation">)</span>

    <span class="token comment"># 将滚动条调整至页面底部</span>
    driver<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'window.scrollTo(0, document.body.scrollHeight)'</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

    <span class="token comment"># 定义初始时间戳（秒）</span>
    t1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 定义循环标识，用于终止while循环</span>
    status <span class="token operator">=</span> <span class="token number">1000</span>

    <span class="token comment"># 重试次数</span>
    num <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">while</span> status <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token comment"># 获取当前时间戳（秒）</span>
        t2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 判断时间初始时间戳和当前时间戳相差是否大于30秒，小于30秒则下拉滚动条</span>
        <span class="token keyword">if</span> t2 <span class="token operator">-</span> t1 <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">:</span>
            new_height <span class="token operator">=</span> driver<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span>js<span class="token punctuation">)</span>
            <span class="token keyword">if</span> new_height <span class="token operator">&gt;</span> height<span class="token punctuation">:</span>
                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                driver<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span>
                    <span class="token string">'window.scrollTo(0, document.body.scrollHeight)'</span><span class="token punctuation">)</span>
                <span class="token comment"># 重置初始页面高度</span>
                height <span class="token operator">=</span> new_height
                <span class="token comment"># 重置初始时间戳，重新计时</span>
                t1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            status <span class="token operator">-=</span> <span class="token number">50</span>
        <span class="token keyword">elif</span> num <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>  <span class="token comment"># 当超过30秒页面高度仍然没有更新时，进入重试逻辑，重试3次，每次等待30秒</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
            num <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 超时并超过重试次数，程序结束跳出循环，并认为页面已经加载完毕！</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;滚动条已经处于页面最下方！&quot;</span><span class="token punctuation">)</span>
            <span class="token comment"># 滚动条调整至页面顶部</span>
            driver<span class="token punctuation">.</span>execute_script<span class="token punctuation">(</span><span class="token string">'window.scrollTo(0, 0)'</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
	<span class="token comment"># 将数据返回，供后面使用</span>
    <span class="token keyword">return</span> driver<span class="token punctuation">.</span>page_source
</code></pre></div><p>使用BeautifulSoup库来解析新闻概况页的内容，获取到新闻标题、新闻更新时间、新闻链接等信息。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd

<span class="token comment"># 使用BeautifulSoup来解析网页内容</span>
<span class="token keyword">def</span> <span class="token function">parseContent</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>
    <span class="token comment"># print(soup)</span>

    <span class="token comment"># 获取今天（现在时间）</span>
    today <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>today<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 昨天</span>
    yesterday <span class="token operator">=</span> today <span class="token operator">-</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> new <span class="token keyword">in</span> soup<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'.news-wrapper&gt;.news-box'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># BeautifulSoup提供的方法通过select选择想要的html节点类名，标签等，获取到的内容会被放到列表中</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>new<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'h4'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>
                    new<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'.other&gt;.name&gt;a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                ls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'疫情'</span><span class="token punctuation">,</span> <span class="token string">'covid-19'</span><span class="token punctuation">,</span> <span class="token string">'疫苗'</span><span class="token punctuation">,</span> <span class="token string">'新冠'</span><span class="token punctuation">]</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> ls<span class="token punctuation">:</span>
                    <span class="token keyword">if</span> i <span class="token keyword">in</span> new<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'h4'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">:</span>
                        obj <span class="token operator">=</span> <span class="token punctuation">{</span>
                            <span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                            <span class="token string">'link'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                            <span class="token string">'time'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                            <span class="token string">'source'</span><span class="token punctuation">:</span> <span class="token string">''</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment"># obj = {}</span>
                        obj<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token operator">=</span> new<span class="token punctuation">.</span>select<span class="token punctuation">(</span>
                            <span class="token string">'h4'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        obj<span class="token punctuation">[</span><span class="token string">'link'</span><span class="token punctuation">]</span> <span class="token operator">=</span> new<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'h4&gt;a'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'href'</span><span class="token punctuation">]</span>

                        <span class="token comment"># 由于时间格式不一样，有的有data-val这个属性，有的没有，所以直接获取标签里面的数据，然后进行转换。</span>
                        tim <span class="token operator">=</span> new<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'.other&gt;.time'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>string<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
                        <span class="token keyword">if</span> tim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'今天'</span><span class="token punctuation">:</span>
                            obj<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> today<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>
                                <span class="token string">&quot;%Y-%m-%d&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> tim<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
                        <span class="token keyword">elif</span> tim<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'昨天'</span><span class="token punctuation">:</span>
                            obj<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> yesterday<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span>
                                <span class="token string">&quot;%Y-%m-%d&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> tim<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
                        <span class="token keyword">else</span><span class="token punctuation">:</span>
                            obj<span class="token punctuation">[</span><span class="token string">'time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span>

                        obj<span class="token punctuation">[</span><span class="token string">'source'</span><span class="token punctuation">]</span> <span class="token operator">=</span> new<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'.other&gt;.name&gt;a'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>string
                        data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
                        <span class="token keyword">break</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment"># 将解析的新闻介绍页详情返回，供后面使用</span>
    <span class="token keyword">return</span> data
</code></pre></div><p>依靠得到的新闻详情链接，使用<code>requests</code>库来获取新闻的详情。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd

<span class="token comment"># 获取每个新闻的详细内容</span>
<span class="token keyword">def</span> <span class="token function">get_newsItemContent</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        lin <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'link'</span><span class="token punctuation">]</span>
        headers <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.140 Safari/537.36'</span><span class="token punctuation">}</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>lin<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>

        <span class="token comment"># 请求获取链接返回的内容</span>
        res<span class="token punctuation">.</span>encoding <span class="token operator">=</span> <span class="token string">'utf-8'</span>  <span class="token comment"># 设置编码格式为utf-8</span>
        <span class="token comment"># 前面已经介绍将html文档格式化为一个树形结构，每个节点都是一个对python对象，方便获取节点内容</span>
        soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>

        cont <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token keyword">for</span> new <span class="token keyword">in</span> soup<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">'#mp-editor &gt; p'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># BeautifulSoup提供的方法通过select选择想要的html节点类名，标签等，获取到的内容会被放到列表中</span>
            p <span class="token operator">=</span> <span class="token string">''</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>new<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> new<span class="token punctuation">.</span>string <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> <span class="token string">'原标题'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> new<span class="token punctuation">.</span>string<span class="token punctuation">:</span>
                p <span class="token operator">=</span> <span class="token string">'&lt;p&gt;'</span> <span class="token operator">+</span> new<span class="token punctuation">.</span>string <span class="token operator">+</span> <span class="token string">'&lt;/p&gt;'</span>
                cont <span class="token operator">+=</span> p
        data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span> <span class="token operator">=</span> cont
    <span class="token keyword">return</span> data
</code></pre></div><h2 id="根据疫情数据预测下一周疫情情况"><a href="#根据疫情数据预测下一周疫情情况" class="header-anchor">#</a> 根据疫情数据预测下一周疫情情况</h2> <p>使用<code>sklearn</code>来大概预测一下疫情的发展，预测结果不提供参考。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> time
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> PolynomialFeatures
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword">import</span> LinearRegression
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> date<span class="token punctuation">,</span> timedelta

<span class="token comment"># 获取国家的数据</span>
<span class="token keyword">def</span> <span class="token function">get_data</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">&quot;../static/data/world_all.csv&quot;</span><span class="token punctuation">)</span>
    d <span class="token operator">=</span> df<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'国家名'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token builtin">str</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
    data <span class="token operator">=</span> d<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'日期'</span><span class="token punctuation">,</span> <span class="token string">'确诊病例'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> data

<span class="token comment"># 获取国家名列表</span>
<span class="token keyword">def</span> <span class="token function">get_names</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'../static/data/countries.csv'</span><span class="token punctuation">)</span>
    lis <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'国家名'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> lis


<span class="token keyword">def</span> <span class="token function">predict_each</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    df <span class="token operator">=</span> get_data<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 获取序列号和日期写序列</span>
        a <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'日期'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        xdata <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
        xlabel <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>item <span class="token keyword">for</span> item <span class="token keyword">in</span> df<span class="token punctuation">[</span><span class="token string">'日期'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        b <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'日期'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
        start_date <span class="token operator">=</span> date<span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">'20'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment"># 为序列和日期增加7天</span>
        xdata<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> a <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        xlabel<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>
            <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token punctuation">(</span>start_date <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%m/%d/%y&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        X <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>xdata<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        y <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'确诊病例'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment"># 因为日期增加了7天，而真实累计病例数据没有变，所以X比y多7天数据，拿5天数据出来做测试</span>
        X_train <span class="token operator">=</span> X<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">]</span>
        y_train <span class="token operator">=</span> y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span>

        <span class="token comment"># --------------------------------四次多项式</span>
        poly4 <span class="token operator">=</span> PolynomialFeatures<span class="token punctuation">(</span>degree<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
        X_ploy <span class="token operator">=</span> poly4<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>X_train<span class="token punctuation">)</span>
        l4 <span class="token operator">=</span> LinearRegression<span class="token punctuation">(</span><span class="token punctuation">)</span>
        l4<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_ploy<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>

        <span class="token comment"># 得到预测后的数据</span>
        <span class="token comment"># x_data = xdata</span>
        y_data <span class="token operator">=</span> l4<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>poly4<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 生成该国的数据</span>
        df_1 <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>y_data<span class="token punctuation">,</span> columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'预测病例'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        df_1<span class="token punctuation">[</span><span class="token string">'日期'</span><span class="token punctuation">]</span> <span class="token operator">=</span> xlabel
        df_1<span class="token punctuation">[</span><span class="token string">'国家名'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">37</span>
        df_2 <span class="token operator">=</span> pd<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>
            left<span class="token operator">=</span>df<span class="token punctuation">,</span>
            right<span class="token operator">=</span>df_1<span class="token punctuation">,</span>
            left_on<span class="token operator">=</span><span class="token string">'日期'</span><span class="token punctuation">,</span>
            right_on<span class="token operator">=</span><span class="token string">'日期'</span><span class="token punctuation">,</span>
            how<span class="token operator">=</span><span class="token string">'outer'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> df_2
    <span class="token keyword">except</span> BaseException<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'文件有错误'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
</code></pre></div><h2 id="编写数据请求接口"><a href="#编写数据请求接口" class="header-anchor">#</a> 编写数据请求接口</h2> <p>在<code>app.py</code>文件中，会处理前端发过来的请求信息，如果将这些处理步骤都放在<code>app.py</code>文件中的话，代码会非常臃肿，所以将数据请求处理的功能提取出来，放到<code>response.py</code>文件中，然后直接在<code>app.py</code>文件中使用这些方法即可。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> json

<span class="token comment"># 获取各个国家的预测数据</span>
<span class="token keyword">def</span> <span class="token function">getPredictData</span><span class="token punctuation">(</span>request_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 读取文件</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">&quot;./static/data/predict.csv&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 依据传递过来的查询词来获取数据</span>
        d <span class="token operator">=</span> df<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>df<span class="token punctuation">[</span><span class="token string">'国家名'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token builtin">str</span><span class="token punctuation">(</span>request_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token comment"># 数据有37天的，只取30天的数据用于展示</span>
        data <span class="token operator">=</span> d<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'日期'</span><span class="token punctuation">,</span> <span class="token string">'确诊病例'</span><span class="token punctuation">,</span> <span class="token string">'预测病例'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token comment"># 将数据格式转换为json格式，方便前端进行处理</span>
        df_json <span class="token operator">=</span> data<span class="token punctuation">.</span>to_json<span class="token punctuation">(</span>orient<span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">,</span> force_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>df_json<span class="token punctuation">)</span>
    <span class="token keyword">except</span> BaseException<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'暂未提供预测数据'</span>
</code></pre></div><h2 id="使用gevent将flask改造成异步服务器"><a href="#使用gevent将flask改造成异步服务器" class="header-anchor">#</a> 使用Gevent将flask改造成异步服务器</h2> <p>flask使用app.run()之后，会显示<code>WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.</code>，说明flask原生的性能不能支持生产环境，需要我们另外构建服务器。</p> <p>Gevent是一个基于greenlet的Python的并发框架，以微线程greenlet为核心，使用了epoll事件监听机制以及诸多其他优化而变得高效。</p> <p>与greenlet、eventlet相比，性能略低，但是它封装的API非常完善，最赞的是提供了一个monkey类，可以将现有基于Python线程直接转化为greenlet，相当于proxy了一下（打了patch）。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> gevent <span class="token keyword">import</span> monkey<span class="token punctuation">,</span> pywsgi
<span class="token keyword">import</span> flask

monkey<span class="token punctuation">.</span>patch_all<span class="token punctuation">(</span><span class="token punctuation">)</span>

app <span class="token operator">=</span> flask<span class="token punctuation">.</span>Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World!'</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># app.run()   原来使用的就是这个命令</span>
    server <span class="token operator">=</span> pywsgi<span class="token punctuation">.</span>WSGIServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span>
    server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>需要手动输入地址<code>127.0.0.1:8888</code>，才能显示页面：</p> <p><img src="https://img-typora-irving.oss-cn-shanghai.aliyuncs.com/img/image-20210123161218203.png" alt="image-20210123161218203"></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/17/2021, 1:44:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/python/python01.html" class="prev">
        Flask构建后端接口
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.b0a15833.js" defer></script><script src="/docs/assets/js/2.18927d2b.js" defer></script><script src="/docs/assets/js/10.5c238dfe.js" defer></script>
  </body>
</html>
